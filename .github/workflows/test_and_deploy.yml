name: ðŸ§ª MiniStudio CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    name: ðŸ”§ Build & Tests
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout du dÃ©pÃ´t
      uses: actions/checkout@v4

    - name: ðŸ Installation de Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11

    - name: ðŸ“¦ Installation des dÃ©pendances
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pytest pytest-asyncio httpx pytest-json-report black flake8

    - name: ðŸ§¹ VÃ©rification du style
      run: |
        black --check fastapi_app
        flake8 fastapi_app --max-line-length=120

    - name: ðŸ§ª ExÃ©cution des tests unitaires
      run: |
        pytest fastapi_app/tests/ -v --maxfail=1 --disable-warnings --json-report --json-report-file=reports/report.json

    - name: ðŸ“„ Copie du rapport CI/CD dans /memory
      run: |
        mkdir -p memory
        cp reports/report.json memory/ci_report_${{ github.run_id }}.json
        echo "[CI/CD] Test run $(date -Iseconds) -> SUCCESS" >> memory/session.log

    - name: ðŸ“¤ TÃ©lÃ©versement des rapports CI/CD
      uses: actions/upload-artifact@v4
      with:
        name: ministudio-ci-report
        path: |
          reports/report.json
          memory/ci_report_*.json

  deploy:
    name: ðŸš€ DÃ©ploiement MiniStudio
    runs-on: ubuntu-latest
    needs: build-and-test

    steps:
    - name: ðŸ“¥ Checkout du dÃ©pÃ´t
      uses: actions/checkout@v4

    - name: ðŸ³ Build de lâ€™image Docker
      run: |
        docker build -t ministudio:latest .

    - name: ðŸ§© Lancement du conteneur Docker
      run: |
        docker-compose down
        docker-compose up -d

    - name: ðŸŒ VÃ©rification du service
      run: |
        sleep 10
        curl -f http://127.0.0.1:8100/project/ping || exit 1

    - name: ðŸ“‹ Log du dÃ©ploiement
      if: always()
      run: |
        if [ "$GITHUB_JOB_STATUS" == "failure" ]; then
          echo "[CD] Ã‰chec du dÃ©ploiement $(date -Iseconds)" >> memory/deploy_report.log
        else
          echo "[CD] DÃ©ploiement rÃ©ussi $(date -Iseconds)" >> memory/deploy_report.log
        fi

        echo "[CD] DÃ©ploiement rÃ©ussi $(date -Iseconds)" >> memory/session.log
        echo "MiniStudio accessible via tunnel Cloudflare : https://ministudio.store"
